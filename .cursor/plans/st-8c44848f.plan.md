<!-- 8c44848f-a7e1-4c53-b0af-da1758c84921 e9b9b508-c1ff-4199-a8a8-d687d9419a1b -->
# Strava Activity Verification & Challenge Completion Flow

## Overview

Implement end-to-end activity verification using Lit Protocol, including UI for verifying runs, marking challenges complete, showing completion stats, and enabling stake withdrawal.

## Phase 1: Backend Services & Lit Protocol Setup

### 1.1 Install Lit Protocol Dependencies

Add to `client/package.json`:

- `@lit-protocol/lit-node-client`
- `@lit-protocol/constants`
- `@lit-protocol/auth-helpers`

### 1.2 Create Lit Protocol Service

Create `client/services/litProtocolService.js`:

- Initialize Lit node client
- Configure for Sepolia network
- Create function to execute Lit actions
- Handle PKP signing for contract calls
- Store authorized oracle address in environment

### 1.3 Create Oracle Verification Service

Create `client/services/verificationService.js`:

- Function to verify Strava activity against challenge
- Call Lit Protocol with challenge and activity data
- Use existing `web3/lit-actions/verifyStravaActivity.js`
- Return verification result and transaction hash

### 1.4 Update Contract Service

In `client/services/contract.js`:

- Add `markTaskComplete()` function with WalletConnect support
- Add `finalizeChallenge()` function with WalletConnect support (already exists, verify it works)
- Add function to get challenge completion statistics
- Use existing `getChallengeParticipants()` and loop to count completed

## Phase 2: Activity Verification Screen

### 2.1 Create VerifyActivity Screen

Create `client/screens/VerifyActivity.js`:

- Accept challenge parameter from navigation
- Fetch user's Strava activities using `stravaService.getAthleteActivities()`
- Filter activities matching challenge criteria (distance, date range, type)
- Display list of qualifying activities with maps
- Show activity details: distance, duration, date, pace
- Add "Verify This Run" button for each activity

### 2.2 Activity Card Component

Within VerifyActivity screen:

- Display activity map (use Strava map polyline)
- Show activity stats (distance, time, pace)
- Highlight if activity meets challenge requirements
- Visual indicator for verification status
- Loading state during verification

### 2.3 Verification Logic

In VerifyActivity screen:

- Validate activity meets challenge criteria
- Call `verificationService.verifyActivity()`
- Show loading state during Lit Protocol execution
- Display success/error alerts
- Navigate back to My Challenges on success

## Phase 3: My Challenges UI Updates

### 3.1 Add Verify Run Button

In `client/screens/MyChallenges.js`:

- Add "Verify Run" button to active challenge cards
- Only show for non-completed, non-finalized challenges
- Check if user has Strava connected before showing
- Navigate to VerifyActivity screen with challenge data

### 3.2 Add Completion Statistics

In `client/screens/MyChallenges.js`:

- Fetch challenge participants for each challenge
- Count how many have `hasCompleted = true`
- Display "X of Y participants completed" in challenge card
- Add progress indicator showing completion percentage

### 3.3 Add Finalize Challenge Button

In `client/screens/MyChallenges.js`:

- Show "Finalize Challenge" button for expired challenges
- Check if `block.timestamp > challenge.endTime`
- Check if not already finalized
- Call `finalizeChallenge()` from contract service
- Show success message and refresh challenges

### 3.4 Update Withdraw Logic

In `client/screens/MyChallenges.js`:

- Ensure withdraw button only shows after finalization
- Display amount user will receive (stake + winnings)
- Show different messages for winners vs losers
- Already implemented, just verify it works

## Phase 4: Progress Tracking

### 4.1 Calculate User Progress

Create helper function in `client/utils/helpers.js`:

- Fetch user's Strava activities in challenge date range
- Sum total distance from verified activities
- Calculate percentage: (totalDistance / targetDistance) * 100
- Return progress data

### 4.2 Update Challenge Cards

In `client/screens/MyChallenges.js`:

- Show progress bar for active challenges
- Display "X km of Y km completed"
- Update progress percentage
- Color-code based on completion (red/yellow/green)

## Phase 5: Navigation & Integration

### 5.1 Add Screen to Navigation

In `client/navigation/AppNavigator.js`:

- Add VerifyActivity screen to stack navigator
- Configure header options
- Set up proper navigation flow

### 5.2 Update Home Dashboard

In `client/screens/Home.js`:

- Verify stats calculation includes completion data
- Ensure active challenges count is accurate
- Add refresh functionality

### 5.3 Strava Connection Check

In relevant screens:

- Check if user has Strava connected
- Show "Connect Strava" prompt if not connected
- Disable "Verify Run" button if not connected

## Phase 6: Environment & Configuration

### 6.1 Environment Variables

Create/update `.env`:

- LIT_PROTOCOL_NETWORK=sepolia
- AUTHORIZED_ORACLE_ADDRESS=<wallet_address>
- CONTRACT_ADDRESS (ensure it's set)

### 6.2 Update Contract ABI

In `client/services/contract.js`:

- Verify `markTaskComplete` is in ABI
- Verify all event signatures are correct
- Update if contract was redeployed

## Phase 7: Testing & Error Handling

### 7.1 Add Error Handling

Throughout all screens:

- Handle Strava API errors
- Handle Lit Protocol errors
- Handle contract transaction failures
- Show user-friendly error messages
- Add retry logic where appropriate

### 7.2 Add Loading States

In all async operations:

- Show loading spinners
- Disable buttons during operations
- Show progress for multi-step processes
- Add timeout handling

## Key Files to Modify

1. `client/services/litProtocolService.js` (new)
2. `client/services/verificationService.js` (new)
3. `client/services/contract.js` (update)
4. `client/screens/VerifyActivity.js` (new)
5. `client/screens/MyChallenges.js` (update)
6. `client/utils/helpers.js` (update)
7. `client/navigation/AppNavigator.js` (update)
8. `client/package.json` (update dependencies)

## Dependencies on Existing Code

- Uses existing `stravaService.js` for activity fetching
- Uses existing `web3/lit-actions/verifyStravaActivity.js`
- Uses existing WalletConnect integration
- Uses existing contract functions where available
- Uses existing UI components and styling

## Success Criteria

- Users can verify Strava activities against challenges
- Lit Protocol successfully marks tasks as complete on-chain
- Completion statistics display correctly
- Anyone can finalize expired challenges
- Winners can withdraw stake + rewards
- Progress tracking updates in real-time
- All transactions go through WalletConnect properly

### To-dos

- [ ] Install Lit Protocol dependencies and create litProtocolService.js
- [ ] Create verificationService.js to handle activity verification with Lit Protocol
- [ ] Create VerifyActivity.js screen with activity list, maps, and verification UI
- [ ] Add Verify Run button, completion stats, and Finalize button to MyChallenges.js
- [ ] Implement progress calculation and display in challenge cards
- [ ] Add VerifyActivity screen to navigation and update routing
- [ ] Add markTaskComplete and verify finalizeChallenge functions in contract.js
- [ ] Set up environment variables for Lit Protocol and oracle address